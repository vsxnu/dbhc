import re
import logging
import os
from typing import List, Tuple
from mssql_module import MSSQLModule
from sybase_module import SybaseModule
from oracle_module import OracleModule

logger = logging.getLogger(__name__)
TEMP_DIR = 'temp_files'

class CommunicationModule:
    def __init__(self):
        self.modules = {
            'MSSQL': MSSQLModule(),
            'Sybase': SybaseModule(),
            'Oracle': OracleModule()
        }

    def process_request(self, db_type: str, hostnames: List[str], request_id: str) -> str:
        if db_type not in self.modules:
            raise ValueError(f"Unsupported database type: {db_type}")

        fqdn_list, errors = self._convert_to_fqdn(hostnames)
        
        valid_fqdns = [fqdn for fqdn, error in zip(fqdn_list, errors) if error is None]
        self._update_servername_list(valid_fqdns, request_id)
        
        module = self.modules[db_type]
        reports = []

        for hostname, fqdn, error in zip(hostnames, fqdn_list, errors):
            if error is None:
                try:
                    report = module.run_health_check([fqdn], request_id)
                    reports.append(f"{hostname}:\n{report}")
                except Exception as e:
                    logger.error(f"Error running health check for {hostname}: {str(e)}")
                    reports.append(f"{hostname}:\nError: Failed to run health check")
            else:
                reports.append(f"{hostname}:\nError: {error}")
        
        return "\n\n".join(reports)

    def _convert_to_fqdn(self, hostname_list: List[str]) -> Tuple[List[str], List[str]]:
        # ... (keep the existing implementation)

    def _add_domain_name(self, hostname: str) -> str:
        # ... (keep the existing implementation)

    def _update_servername_list(self, valid_fqdns: List[str], request_id: str):
        with open(os.path.join(TEMP_DIR, f'servername_list_{request_id}.txt'), 'w') as f:
            for fqdn in valid_fqdns:
                f.write(f"{fqdn}\n")
